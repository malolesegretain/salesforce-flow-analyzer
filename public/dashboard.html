<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Analysis Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        .actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #1976d2;
            color: white;
        }
        .btn-primary:hover {
            background: #1565c0;
        }
        .btn-secondary {
            background: #757575;
            color: white;
        }
        .btn-secondary:hover {
            background: #616161;
        }
        .btn-danger {
            background: #d32f2f;
            color: white;
        }
        .btn-danger:hover {
            background: #c62828;
        }
        .btn-success {
            background: #4caf50;
            color: white;
        }
        .btn-success:hover {
            background: #45a049;
        }
        .main-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            position: relative;
        }
        .spinner-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #1976d2;
            border-radius: 50%;
            animation: spinner-bounce 1.4s ease-in-out infinite both;
        }
        .spinner-dot:nth-child(1) { top: 0; left: 24px; animation-delay: -0.32s; }
        .spinner-dot:nth-child(2) { top: 12px; left: 48px; animation-delay: -0.16s; }
        .spinner-dot:nth-child(3) { top: 36px; left: 48px; animation-delay: 0s; }
        .spinner-dot:nth-child(4) { top: 48px; left: 24px; animation-delay: 0.16s; }
        .spinner-dot:nth-child(5) { top: 36px; left: 0; animation-delay: 0.32s; }
        .spinner-dot:nth-child(6) { top: 12px; left: 0; animation-delay: 0.48s; }
        
        .progress-container {
            margin: 20px 0;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1976d2, #42a5f5);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        .progress-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .progress-percent {
            font-size: 18px;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .progress-details {
            font-size: 12px;
            color: #888;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        @keyframes spinner-bounce {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            } 
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .chat-interface {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #1976d2;
        }
        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
        }
        .chat-message.user {
            background: #e3f2fd;
            text-align: right;
        }
        .chat-message.ai {
            background: #f8f9fa;
            border-left: 4px solid #1976d2;
            line-height: 1.8;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            white-space: pre-wrap;
        }
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .chat-send {
            padding: 10px 20px;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .chat-send:hover:not(:disabled) {
            background: #1565c0;
        }
        .chat-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Flow Interaction Interface Styles */
        .flow-interaction-interface {
            margin-top: 30px;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
        }
        .interaction-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .interaction-header h2 {
            color: #4caf50;
            margin: 0;
            font-size: 24px;
        }
        .interaction-header p {
            color: #666;
            margin: 5px 0 0 0;
            font-size: 14px;
        }
        .interaction-messages {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .interaction-input-container {
            display: flex;
            gap: 10px;
        }
        .interaction-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .interaction-send {
            padding: 10px 20px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .interaction-send:hover:not(:disabled) {
            background: #45a049;
        }
        .interaction-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #1976d2;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #1976d2;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        .flow-list {
            margin-top: 30px;
        }
        .flow-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #fafafa;
        }
        .flow-name {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }
        .flow-meta {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        .flow-type {
            background: #e3f2fd;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 10px;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .success {
            color: #2e7d32;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn-ai {
            background: #4CAF50;
            color: white;
        }
        .btn-ai:hover {
            background: #45a049;
        }
        .ai-results {
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 16px;
            border: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        .ai-results::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #4CAF50, #2196F3, #FF9800, #9C27B0);
            border-radius: 16px 16px 0 0;
        }
        .ai-results h2 {
            color: #1976d2;
            font-size: 28px;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .ai-section {
            margin-bottom: 40px;
        }
        .ai-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .ai-section p {
            line-height: 1.8;
            color: #555;
            font-size: 16px;
        }
        
        /* Flow Selection Styles */
        .flow-selection {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .flow-selection h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .flow-selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-container input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }
        
        .bulk-actions {
            display: flex;
            gap: 10px;
        }
        
        .flow-sections {
            margin: 20px 0;
        }
        
        .flow-section {
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .flow-section h3 {
            background: #f1f3f4;
            padding: 15px 20px;
            margin: 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .active-section h3 {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .inactive-section h3 {
            background: #fff3e0;
            color: #f57f17;
        }
        
        .flows-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .flow-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            transition: background 0.2s;
        }
        
        .flow-item:hover {
            background: #f8f9fa;
        }
        
        .flow-item.selected {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .flow-item input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
        }
        
        .flow-info {
            flex: 1;
        }
        
        .flow-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }
        
        .flow-details {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 15px;
        }
        
        .flow-selection-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .selected-count {
            font-weight: 600;
            color: #333;
        }
        
        .selection-actions {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            Salesforce Flow Analyzer
            <div id="orgIndicator" style="font-size: 12px; font-weight: normal; opacity: 0.8; margin-top: 5px;">
                Loading org info...
            </div>
        </div>
        <div class="actions">
            <button class="btn btn-ai" onclick="showAIModal()" id="aiConfigBtn">Configure AI</button>
            <button class="btn btn-secondary" onclick="exportJSON()" id="exportBtn" disabled>Export JSON</button>
            <button class="btn btn-danger" onclick="logout()" id="logoutBtn">Logout</button>
        </div>
    </div>

    <div class="main-content">
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner">
                <div class="spinner-dot"></div>
                <div class="spinner-dot"></div>
                <div class="spinner-dot"></div>
                <div class="spinner-dot"></div>
                <div class="spinner-dot"></div>
                <div class="spinner-dot"></div>
            </div>
            <p id="loadingText">Analyzing flows... This may take a few minutes.</p>
            
            <div id="progressContainer" class="progress-container" style="display: none;">
                <div class="progress-percent" id="progressPercent">0%</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">Starting...</div>
                <div class="progress-details" id="progressDetails"></div>
            </div>
        </div>

        <div id="welcome" class="welcome">
            <h2>Welcome to Flow Analysis Dashboard</h2>
            <p>Please configure your AI settings to begin analyzing your Salesforce flows.</p>
            <p>The tool will automatically analyze your flows and provide comprehensive insights.</p>
        </div>

        <div id="flowSelection" class="flow-selection" style="display: none;">
            <h2>Select Flows to Analyze</h2>
            <p>Choose which flows you'd like to analyze. You can select individual flows or use the bulk selection options.</p>
            
            <div class="flow-selection-controls">
                <div class="search-container">
                    <input type="text" id="flowSearchInput" placeholder="Search flows..." />
                    <button id="clearSearch">Clear</button>
                </div>
                
                <div class="bulk-actions">
                    <button id="selectAllActive" class="btn btn-secondary">Select All Active</button>
                    <button id="selectAllInactive" class="btn btn-secondary">Select All Inactive</button>
                    <button id="clearAll" class="btn btn-secondary">Clear All</button>
                </div>
            </div>
            
            <div class="flow-sections">
                <div class="flow-section active-section">
                    <h3 id="activeFlowsHeader">Active Flows (0)</h3>
                    <div id="activeFlowsList" class="flows-list"></div>
                </div>
                
                <div class="flow-section inactive-section">
                    <h3 id="inactiveFlowsHeader">Inactive Flows (0)</h3>
                    <div id="inactiveFlowsList" class="flows-list"></div>
                </div>
            </div>
            
            <div class="flow-selection-footer">
                <div class="selected-count">
                    <span id="selectedCount">0 flows selected</span>
                </div>
                <div class="selection-actions">
                    <button id="cancelSelection" class="btn btn-secondary">Cancel</button>
                    <button id="interactWithFlows" class="btn btn-success" disabled>Interact with my flows without analysing them first</button>
                    <button id="proceedWithSelection" class="btn btn-primary" disabled>Analyze Selected Flows</button>
                </div>
            </div>
        </div>

        <div id="results" style="display: none;">
            <div class="stats" id="stats"></div>
            <div class="flow-list" id="flowList"></div>
        </div>

        <div id="message"></div>
        
        <div id="aiResults" class="ai-results" style="display: none;">
            <h2>AI Analysis Results</h2>
            <div id="aiContent"></div>
        </div>
        
        <div id="chatInterface" class="chat-interface" style="display: none;">
            <h3>Ask Follow-up Questions</h3>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message ai">
                    <strong>AI Assistant:</strong> I've completed the analysis of your Salesforce flows. Feel free to ask me any follow-up questions about the flows, improvements, or specific recommendations!
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Ask a question about your flows..." onkeypress="handleChatKeyPress(event)">
                <button class="chat-send" id="chatSend" onclick="sendChatMessage()">Send</button>
            </div>
        </div>
        
        <div id="flowInteractionInterface" class="flow-interaction-interface" style="display: none;">
            <div class="interaction-header">
                <h2>Interact with Flow JSON</h2>
                <p>Ask questions directly about the JSON data of your selected flows without formal analysis.</p>
                <button class="btn btn-secondary" onclick="closeFlowInteraction()" style="float: right;">Close</button>
                <div style="clear: both;"></div>
            </div>
            <div class="interaction-messages" id="interactionMessages">
                <div class="chat-message ai">
                    <strong>AI Assistant:</strong> I have access to the JSON data of your selected flows. Ask me anything about their structure, logic, elements, or configuration!
                </div>
            </div>
            <div class="interaction-input-container">
                <input type="text" class="interaction-input" id="interactionInput" placeholder="Ask about flow structure, elements, logic..." onkeypress="handleInteractionKeyPress(event)">
                <button class="interaction-send" id="interactionSend" onclick="sendInteractionMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- AI Configuration Modal -->
    <div id="aiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>AI Analysis Configuration</h2>
                <span class="close" onclick="closeAIModal()">&times;</span>
            </div>
            <form id="aiConfigForm">
                <div class="form-group">
                    <label for="aiProvider">AI Provider:</label>
                    <select id="aiProvider" name="aiProvider" required>
                        <option value="">Select AI Provider</option>
                        <option value="openai">OpenAI (GPT-4)</option>
                        <option value="claude">Anthropic Claude</option>
                        <option value="mistral">Mistral AI</option>
                        <option value="gemini">Google Gemini</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="apiKey">API Key:</label>
                    <input type="password" id="apiKey" name="apiKey" required placeholder="Enter your API key">
                    <small id="apiKeyHelp" style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        Select a provider above to see API key instructions
                    </small>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-ai">Start AI Analysis</button>
                    <button type="button" class="btn btn-secondary" onclick="clearAISettings()" style="margin-left: 10px;">Clear Saved Settings</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        console.log('🚀 Dashboard JavaScript loaded successfully!');
        let flowsData = null;
        let aiConfigured = false;
        let salesforceInstanceUrl = null;

        // Show AI config modal immediately when page loads
        window.addEventListener('load', function() {
            console.log('🔄 Page load event fired');
            
            // Load org info
            loadOrgInfo();
            
            if (!hasValidAIConfig()) {
                showAIModal();
            } else {
                // Auto-start if we have saved config
                aiConfigured = true;
                autoStartAnalysis();
            }
        });

        async function loadOrgInfo() {
            try {
                const response = await fetch('/api/org-info');
                if (response.ok) {
                    const orgInfo = await response.json();
                    const orgIndicator = document.getElementById('orgIndicator');
                    orgIndicator.innerHTML = `Connected to: ${orgInfo.orgName}`;
                } else {
                    document.getElementById('orgIndicator').innerHTML = 'Organization info unavailable';
                }
            } catch (error) {
                console.error('Failed to load org info:', error);
                document.getElementById('orgIndicator').innerHTML = 'Error loading org info';
            }
        }

        // Test function to verify formatting works
        function testFormatting() {
            console.log('🧪 Testing formatting function...');
            const testMessage = "1. Create Custom Object 2. Modify Blue - Post to chatter Flow A. In the Record Update element: - Click on the element B. Create Assignment element";
            const formatted = formatChatMessage(testMessage);
            console.log('✅ Test formatting result:', formatted);
            addChatMessage('ai', testMessage);
        }
        
        // Make test function available globally for manual testing
        window.testFormatting = testFormatting;

        function hasValidAIConfig() {
            return localStorage.getItem('aiProvider') && localStorage.getItem('aiApiKey');
        }

        async function autoStartAnalysis() {
            if (!aiConfigured) {
                showAIModal();
                return;
            }

            setLoadingState(true, 'Retrieving flow data from Salesforce...');
            
            try {
                // First check if we're authenticated by testing a simple endpoint
                const authCheck = await fetch('/api/org-info');
                if (!authCheck.ok) {
                    throw new Error('Please login to Salesforce first');
                }
                
                // Use the new progress endpoint with Server-Sent Events
                const eventSource = new EventSource('/api/flows/progress');
                
                // Show progress container
                document.getElementById('progressContainer').style.display = 'block';
                
                // Set up timeout for SSE connection (5 minutes)
                const sseTimeout = setTimeout(() => {
                    console.log('SSE connection timed out, falling back to regular API');
                    eventSource.close();
                    
                    // Fallback to regular API
                    fallbackToRegularAPI();
                }, 5 * 60 * 1000); // 5 minutes
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'init') {
                        console.log('SSE connection established:', data.message);
                    } else if (data.type === 'heartbeat') {
                        console.log('SSE heartbeat received');
                    } else if (data.type === 'progress') {
                        updateProgressBar(data.percent, data.message, data.current, data.total);
                    } else if (data.type === 'complete') {
                        clearTimeout(sseTimeout);
                        eventSource.close();
                        flowsData = data.data;
                        
                        // Get instance URL for flow links
                        fetch('/api/instance')
                            .then(response => response.ok ? response.json() : null)
                            .then(instanceData => {
                                if (instanceData) {
                                    salesforceInstanceUrl = instanceData.instanceUrl;
                                    console.log('Salesforce instance URL retrieved:', salesforceInstanceUrl);
                                }
                            })
                            .catch(error => console.log('Failed to get instance URL:', error));
                        
                        // Show flow selection screen
                        showFlowSelectionScreen();
                        
                    } else if (data.type === 'error') {
                        clearTimeout(sseTimeout);
                        eventSource.close();
                        setLoadingState(false);
                        document.getElementById('welcome').style.display = 'block';
                        document.getElementById('message').innerHTML = '<div class="error">❌ Error: ' + data.message + '</div>';
                        console.error('Error:', data.message);
                    }
                };
                
                eventSource.onerror = function(event) {
                    console.error('EventSource failed:', event);
                    clearTimeout(sseTimeout);
                    eventSource.close();
                    
                    // Fallback to regular API
                    fallbackToRegularAPI();
                };
                
            } catch (error) {
                setLoadingState(false);
                document.getElementById('welcome').style.display = 'block';
                document.getElementById('message').innerHTML = '<div class="error">❌ Error: ' + error.message + '</div>';
                console.error('Error:', error);
            }
        }
        
        function fallbackToRegularAPI() {
            // Fallback to the original API endpoint without progress
            console.log('Falling back to original API endpoint...');
            setLoadingState(true, 'Retrieving flow data from Salesforce...');
            
            // Hide progress container since we're falling back
            document.getElementById('progressContainer').style.display = 'none';
            
            // Use the original flow retrieval method
            Promise.all([
                fetch('/api/flows'),
                fetch('/api/instance')
            ])
            .then(([flowResponse, instanceResponse]) => {
                if (!flowResponse.ok) {
                    throw new Error(`HTTP error! status: ${flowResponse.status}`);
                }
                
                return Promise.all([
                    flowResponse.json(),
                    instanceResponse.ok ? instanceResponse.json() : null
                ]);
            })
            .then(([flowsDataResult, instanceData]) => {
                flowsData = flowsDataResult;
                
                if (instanceData) {
                    salesforceInstanceUrl = instanceData.instanceUrl;
                    console.log('Salesforce instance URL retrieved:', salesforceInstanceUrl);
                }
                
                // Show flow selection screen
                showFlowSelectionScreen();
            })
            .catch(error => {
                setLoadingState(false);
                document.getElementById('welcome').style.display = 'block';
                document.getElementById('message').innerHTML = '<div class="error">❌ Error: ' + error.message + '</div>';
                console.error('Error:', error);
            });
        }

        // Flow Selection Functions
        let selectedFlows = [];
        let allFlows = [];
        
        function showFlowSelectionScreen() {
            setLoadingState(false);
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('flowSelection').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('aiResults').style.display = 'none';
            
            // Populate flows
            allFlows = flowsData.flows || [];
            selectedFlows = [];
            
            populateFlowLists();
            setupFlowSelectionEvents();
        }
        
        function populateFlowLists() {
            const activeFlows = allFlows.filter(flow => flow.isActive);
            const inactiveFlows = allFlows.filter(flow => !flow.isActive);
            
            // Update headers
            document.getElementById('activeFlowsHeader').textContent = `Active Flows (${activeFlows.length})`;
            document.getElementById('inactiveFlowsHeader').textContent = `Inactive Flows (${inactiveFlows.length})`;
            
            // Populate active flows
            const activeFlowsList = document.getElementById('activeFlowsList');
            activeFlowsList.innerHTML = '';
            activeFlows.forEach(flow => {
                const flowItem = createFlowItem(flow);
                activeFlowsList.appendChild(flowItem);
            });
            
            // Populate inactive flows
            const inactiveFlowsList = document.getElementById('inactiveFlowsList');
            inactiveFlowsList.innerHTML = '';
            inactiveFlows.forEach(flow => {
                const flowItem = createFlowItem(flow);
                inactiveFlowsList.appendChild(flowItem);
            });
            
            updateSelectedCount();
            
            // Restore previously selected flows from localStorage
            restoreSelectedFlows();
        }
        
        function restoreSelectedFlows() {
            const savedSelections = localStorage.getItem('selectedFlows');
            if (savedSelections) {
                try {
                    const savedFlowIds = JSON.parse(savedSelections);
                    selectedFlows = [];
                    
                    savedFlowIds.forEach(flowId => {
                        const flowItem = document.querySelector(`[data-flow-id="${flowId}"]`);
                        if (flowItem) {
                            const checkbox = flowItem.querySelector('input[type="checkbox"]');
                            if (checkbox) {
                                checkbox.checked = true;
                                selectedFlows.push(flowId);
                                flowItem.classList.add('selected');
                            }
                        }
                    });
                    
                    updateSelectedCount();
                } catch (error) {
                    console.warn('Failed to restore selected flows from localStorage:', error);
                    localStorage.removeItem('selectedFlows');
                }
            }
        }
        
        function createFlowItem(flow) {
            const flowItem = document.createElement('div');
            flowItem.className = 'flow-item';
            flowItem.dataset.flowId = flow.Id;
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `flow-${flow.Id}`;
            checkbox.addEventListener('change', handleFlowSelection);
            
            const flowInfo = document.createElement('div');
            flowInfo.className = 'flow-info';
            
            const flowName = document.createElement('div');
            flowName.className = 'flow-name';
            flowName.textContent = flow.MasterLabel || flow.FullName || 'Unnamed Flow';
            
            const flowDetails = document.createElement('div');
            flowDetails.className = 'flow-details';
            
            const statusSpan = document.createElement('span');
            statusSpan.textContent = `Status: ${flow.Status}`;
            
            const typeSpan = document.createElement('span');
            typeSpan.textContent = `Type: ${flow.ProcessType}`;
            
            const apiVersionSpan = document.createElement('span');
            apiVersionSpan.textContent = `API: ${flow.ApiVersion || 'N/A'}`;
            
            flowDetails.appendChild(statusSpan);
            flowDetails.appendChild(typeSpan);
            flowDetails.appendChild(apiVersionSpan);
            
            flowInfo.appendChild(flowName);
            flowInfo.appendChild(flowDetails);
            
            flowItem.appendChild(checkbox);
            flowItem.appendChild(flowInfo);
            
            return flowItem;
        }
        
        function handleFlowSelection(event) {
            const checkbox = event.target;
            const flowId = checkbox.closest('.flow-item').dataset.flowId;
            const flowItem = checkbox.closest('.flow-item');
            
            if (checkbox.checked) {
                selectedFlows.push(flowId);
                flowItem.classList.add('selected');
            } else {
                selectedFlows = selectedFlows.filter(id => id !== flowId);
                flowItem.classList.remove('selected');
            }
            
            // Save selected flows to localStorage
            localStorage.setItem('selectedFlows', JSON.stringify(selectedFlows));
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const count = selectedFlows.length;
            document.getElementById('selectedCount').textContent = `${count} flow${count !== 1 ? 's' : ''} selected`;
            document.getElementById('proceedWithSelection').disabled = count === 0;
            document.getElementById('interactWithFlows').disabled = count === 0;
        }
        
        function setupFlowSelectionEvents() {
            // Search functionality
            const searchInput = document.getElementById('flowSearchInput');
            searchInput.addEventListener('input', filterFlows);
            
            document.getElementById('clearSearch').addEventListener('click', () => {
                searchInput.value = '';
                filterFlows();
            });
            
            // Bulk actions
            document.getElementById('selectAllActive').addEventListener('click', () => {
                selectFlowsByStatus(true);
            });
            
            document.getElementById('selectAllInactive').addEventListener('click', () => {
                selectFlowsByStatus(false);
            });
            
            document.getElementById('clearAll').addEventListener('click', () => {
                clearAllSelections();
            });
            
            // Footer actions
            document.getElementById('cancelSelection').addEventListener('click', () => {
                document.getElementById('flowSelection').style.display = 'none';
                document.getElementById('welcome').style.display = 'block';
            });
            
            document.getElementById('proceedWithSelection').addEventListener('click', () => {
                proceedWithSelectedFlows();
            });
            
            document.getElementById('interactWithFlows').addEventListener('click', () => {
                startFlowInteraction();
            });
        }
        
        function filterFlows() {
            const searchTerm = document.getElementById('flowSearchInput').value.toLowerCase();
            const flowItems = document.querySelectorAll('.flow-item');
            
            flowItems.forEach(item => {
                const flowName = item.querySelector('.flow-name').textContent.toLowerCase();
                const flowDetails = item.querySelector('.flow-details').textContent.toLowerCase();
                
                if (flowName.includes(searchTerm) || flowDetails.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function selectFlowsByStatus(isActive) {
            const flowItems = document.querySelectorAll('.flow-item');
            
            flowItems.forEach(item => {
                const flowId = item.dataset.flowId;
                const flow = allFlows.find(f => f.Id === flowId);
                const checkbox = item.querySelector('input[type="checkbox"]');
                
                if (flow && flow.isActive === isActive) {
                    if (!checkbox.checked) {
                        checkbox.checked = true;
                        selectedFlows.push(flowId);
                        item.classList.add('selected');
                    }
                }
            });
            
            // Save selected flows to localStorage
            localStorage.setItem('selectedFlows', JSON.stringify(selectedFlows));
            updateSelectedCount();
        }
        
        function clearAllSelections() {
            selectedFlows = [];
            const checkboxes = document.querySelectorAll('.flow-item input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.flow-item').classList.remove('selected');
            });
            // Save empty selection to localStorage
            localStorage.setItem('selectedFlows', JSON.stringify(selectedFlows));
            updateSelectedCount();
        }
        
        function proceedWithSelectedFlows() {
            if (selectedFlows.length === 0) {
                alert('Please select at least one flow to analyze.');
                return;
            }
            
            // Filter flowsData to only include selected flows
            const selectedFlowsData = {
                ...flowsData,
                flows: flowsData.flows.filter(flow => selectedFlows.includes(flow.Id))
            };
            
            // Update metadata
            selectedFlowsData.metadata.totalFlows = selectedFlowsData.flows.length;
            selectedFlowsData.metadata.activeFlows = selectedFlowsData.flows.filter(f => f.isActive).length;
            selectedFlowsData.metadata.inactiveFlows = selectedFlowsData.flows.filter(f => !f.isActive).length;
            
            // Hide flow selection and start analysis
            document.getElementById('flowSelection').style.display = 'none';
            startAnalysisWithSelectedFlows(selectedFlowsData);
        }
        
        async function startAnalysisWithSelectedFlows(selectedFlowsData) {
            setLoadingState(true, 'Analyzing selected flows with AI... This may take several minutes.');
            
            try {
                const aiProvider = localStorage.getItem('aiProvider');
                const apiKey = localStorage.getItem('aiApiKey');
                
                const aiResponse = await fetch('/api/flows/ai-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        provider: aiProvider,
                        apiKey: apiKey,
                        flowsData: selectedFlowsData
                    })
                });
                
                if (!aiResponse.ok) {
                    throw new Error(`AI Analysis failed with status: ${aiResponse.status}`);
                }
                
                const aiResults = await aiResponse.json();
                
                setLoadingState(false);
                displayResults(selectedFlowsData);
                displayAIResults(aiResults);
                showChatInterface();
                
                document.getElementById('message').innerHTML = '<div class="success">✅ Flow analysis complete! Ready for questions.</div>';
                
            } catch (error) {
                setLoadingState(false);
                document.getElementById('flowSelection').style.display = 'block';
                document.getElementById('message').innerHTML = '<div class="error">❌ Error: ' + error.message + '</div>';
                console.error('Error:', error);
            }
        }

        function setLoadingState(isLoading, text = 'Loading...') {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const welcome = document.getElementById('welcome');
            const results = document.getElementById('results');
            const aiResults = document.getElementById('aiResults');
            const flowSelection = document.getElementById('flowSelection');
            const progressContainer = document.getElementById('progressContainer');
            
            if (isLoading) {
                loading.style.display = 'block';
                welcome.style.display = 'none';
                results.style.display = 'none';
                aiResults.style.display = 'none';
                flowSelection.style.display = 'none';
                loadingText.textContent = text;
                disableAllButtons(true);
            } else {
                loading.style.display = 'none';
                progressContainer.style.display = 'none';
                disableAllButtons(false);
                // Enable export buttons
                document.getElementById('exportBtn').disabled = false;
            }
        }

        function updateProgressBar(percent, message, current, total) {
            const progressPercent = document.getElementById('progressPercent');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressDetails = document.getElementById('progressDetails');
            
            progressPercent.textContent = percent + '%';
            progressFill.style.width = percent + '%';
            progressText.textContent = message;
            
            if (current !== undefined && total !== undefined) {
                progressDetails.textContent = `Processing ${current} of ${total} flows`;
            } else {
                progressDetails.textContent = '';
            }
        }

        function disableAllButtons(disabled) {
            const buttons = ['aiConfigBtn', 'exportBtn', 'logoutBtn'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = disabled;
                    btn.style.opacity = disabled ? '0.5' : '1';
                    btn.style.cursor = disabled ? 'not-allowed' : 'pointer';
                }
            });
        }

        function displayResults(data) {
            const stats = document.getElementById('stats');
            const flowList = document.getElementById('flowList');
            
            // Display stats
            const flowTypes = {};
            data.flows.forEach(flow => {
                const processType = flow.ProcessType || 'Unknown';
                flowTypes[processType] = (flowTypes[processType] || 0) + 1;
            });
            
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${data.metadata.totalFlows}</div>
                    <div class="stat-label">Total Active Flows</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Object.keys(flowTypes).length}</div>
                    <div class="stat-label">Different Flow Types</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.flows.filter(f => f.error).length}</div>
                    <div class="stat-label">Flows with Errors</div>
                </div>
            `;
            
            // Display flow list
            flowList.innerHTML = `
                <h3>Flow Details</h3>
                ${data.flows.map(flow => `
                    <div class="flow-item">
                        <div class="flow-name">
                            ${generateFlowLink(flow)}
                        </div>
                        <div class="flow-meta">
                            <span class="flow-type">${flow.ProcessType || 'Unknown'}</span>
                            <strong>Developer Name:</strong> ${flow.FullName}
                        </div>
                        <div class="flow-meta">
                            <strong>Created:</strong> ${new Date(flow.CreatedDate).toLocaleString()} by ${flow.CreatedBy || 'Unknown'}
                        </div>
                        <div class="flow-meta">
                            <strong>Last Modified:</strong> ${new Date(flow.LastModifiedDate).toLocaleString()} by ${flow.LastModifiedBy || 'Unknown'}
                        </div>
                        ${flow.Metadata?.description ? `<div class="flow-meta"><strong>Description:</strong> ${flow.Metadata.description}</div>` : ''}
                        ${flow.error ? `<div class="error">Error: ${flow.error}</div>` : ''}
                        ${flow.Metadata ? `<div class="flow-meta"><strong>Elements:</strong> ${getElementCount(flow.Metadata)}</div>` : ''}
                    </div>
                `).join('')}
            `;
        }

        function generateFlowLink(flow) {
            const flowName = flow.MasterLabel || flow.FullName;
            
            if (salesforceInstanceUrl && flow.Id) {
                // Create Salesforce Flow Builder URL (Lightning Experience)
                const flowBuilderUrl = `${salesforceInstanceUrl}/builder_platform_interaction/flowBuilder.app?flowId=${flow.Id}`;
                
                // Alternative: Classic Flow Designer URL as fallback
                const classicFlowUrl = `${salesforceInstanceUrl}/flow/flowDesigner.app?flowId=${flow.Id}`;
                
                return `<a href="${flowBuilderUrl}" target="_blank" style="color: #1976d2; text-decoration: none; font-weight: bold;" 
                         title="Open in Flow Builder (${flow.Id})">
                    ${flowName} 🔗
                </a>`;
            } else {
                console.log('Missing data for flow link:', { salesforceInstanceUrl, flowId: flow.Id, flowName });
                return flowName;
            }
        }

        function generateFlowLinkFromName(flowName) {
            if (!flowsData || !salesforceInstanceUrl) {
                return flowName;
            }
            
            // Find the flow by name in our flowsData
            const flow = flowsData.flows.find(f => 
                (f.MasterLabel && f.MasterLabel === flowName) || 
                (f.FullName && f.FullName === flowName)
            );
            
            if (flow && flow.Id) {
                const flowBuilderUrl = `${salesforceInstanceUrl}/builder_platform_interaction/flowBuilder.app?flowId=${flow.Id}`;
                return `<a href="${flowBuilderUrl}" target="_blank" style="color: #1976d2; text-decoration: none;">
                    ${flowName} 🔗
                </a>`;
            } else {
                return flowName;
            }
        }

        function getElementCount(metadata) {
            if (!metadata) return 'N/A';
            let count = 0;
            const elements = ['actionCalls', 'decisions', 'recordLookups', 'recordUpdates', 'recordCreates', 'assignments', 'formulas'];
            elements.forEach(element => {
                if (metadata[element] && Array.isArray(metadata[element])) {
                    count += metadata[element].length;
                }
            });
            return count;
        }

        async function exportJSON() {
            if (!flowsData) {
                alert('Please analyze flows first');
                return;
            }
            
            try {
                const response = await fetch('/api/flows/export');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `all-flows-detailed-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                document.getElementById('message').innerHTML = '<div class="success">✅ JSON export downloaded successfully!</div>';
            } catch (error) {
                document.getElementById('message').innerHTML = '<div class="error">❌ Error exporting JSON: ' + error.message + '</div>';
            }
        }


        async function logout() {
            try {
                // Clear localStorage first
                localStorage.removeItem('aiProvider');
                localStorage.removeItem('aiApiKey');
                localStorage.removeItem('selectedFlows');
                
                // Reset page state
                flowsData = null;
                aiConfigured = false;
                salesforceInstanceUrl = null;
                
                // Call server logout
                await fetch('/auth/logout', { 
                    method: 'POST',
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                // Show success message briefly
                document.getElementById('message').innerHTML = '<div class="success">✅ Logged out successfully. Redirecting...</div>';
                
                // Force redirect with cache busting
                setTimeout(() => {
                    window.location.replace('/?t=' + Date.now());
                }, 1000);
                
            } catch (error) {
                console.error('Logout error:', error);
                // Clear localStorage anyway and redirect
                localStorage.removeItem('aiProvider');
                localStorage.removeItem('aiApiKey');
                // Force redirect even if server call failed
                window.location.replace('/?t=' + Date.now());
            }
        }

        function showAIModal() {
            // Load saved settings
            loadSavedAISettings();
            
            document.getElementById('aiModal').style.display = 'block';
        }
        
        function loadSavedAISettings() {
            const savedProvider = localStorage.getItem('aiProvider');
            const savedApiKey = localStorage.getItem('aiApiKey');
            
            if (savedProvider) {
                document.getElementById('aiProvider').value = savedProvider;
                // Trigger change event to show API key instructions
                document.getElementById('aiProvider').dispatchEvent(new Event('change'));
            }
            
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
        }
        
        function saveAISettings(provider, apiKey) {
            localStorage.setItem('aiProvider', provider);
            localStorage.setItem('aiApiKey', apiKey);
        }
        
        function clearAISettings() {
            localStorage.removeItem('aiProvider');
            localStorage.removeItem('aiApiKey');
            document.getElementById('aiProvider').value = '';
            document.getElementById('apiKey').value = '';
            document.getElementById('apiKeyHelp').innerHTML = 'Select a provider above to see API key instructions';
            alert('Saved settings cleared!');
        }

        function closeAIModal() {
            document.getElementById('aiModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('aiModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Show API key instructions based on provider selection
        document.getElementById('aiProvider').addEventListener('change', function(e) {
            const provider = e.target.value;
            const helpText = document.getElementById('apiKeyHelp');
            
            switch(provider) {
                case 'openai':
                    helpText.innerHTML = '🔑 Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a><br>Key format: sk-...';
                    break;
                case 'claude':
                    helpText.innerHTML = '🔑 Get your API key from <a href="https://console.anthropic.com/" target="_blank">Anthropic Console</a><br>Key format: sk-ant-api03-...';
                    break;
                case 'mistral':
                    helpText.innerHTML = '🔑 Get your API key from <a href="https://console.mistral.ai/" target="_blank">Mistral Console</a><br>Key format: starts with your account identifier';
                    break;
                case 'gemini':
                    helpText.innerHTML = '🔑 Get your API key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a><br>Key format: AIza...<br><small>⚠️ Must start with "AIza" - if you get 404 errors, verify your key format and regional availability</small>';
                    break;
                default:
                    helpText.innerHTML = 'Select a provider above to see API key instructions';
            }
        });

        document.getElementById('aiConfigForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const aiProvider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('apiKey').value;
            
            if (!aiProvider || !apiKey) {
                alert('Please fill in all fields');
                return;
            }
            
            // Test API key with a simple request first
            setLoadingState(true, 'Validating API key...');
            
            try {
                const testResponse = await fetch('/api/flows/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: 'Hello, can you confirm you can respond?'
                    })
                });
                
                // If we get 400 with missing context, that's expected - API key works
                if (testResponse.status === 400) {
                    // Save settings and proceed
                    saveAISettings(aiProvider, apiKey);
                    aiConfigured = true;
                    closeAIModal();
                    autoStartAnalysis();
                    return;
                }
                
                throw new Error('API key validation failed');
                
            } catch (error) {
                // Save settings anyway and try the analysis
                saveAISettings(aiProvider, apiKey);
                aiConfigured = true;
                closeAIModal();
                autoStartAnalysis();
            }
        });

        function displayAIResults(results) {
            const aiResults = document.getElementById('aiResults');
            const aiContent = document.getElementById('aiContent');
            
            // Format content with proper HTML rendering and visual enhancements
            aiContent.innerHTML = `
                <div class="ai-section">
                    <h3 style="font-size: 24px; margin-bottom: 15px; color: #1976d2;">
                        🏢 Organization Overview
                    </h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #1976d2; line-height: 1.7;">
                        ${formatMarkdownContent(results.organizationOverview)}
                    </div>
                </div>
                
                <div class="ai-section">
                    <h3 style="font-size: 24px; margin-bottom: 15px; color: #d32f2f;">
                        ⚠️ Potential Risks & Concerns
                    </h3>
                    <div style="background: #fff3e0; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #ff9800; line-height: 1.7;">
                        ${formatMarkdownContent(results.potentialRisks)}
                    </div>
                </div>
                
                <div class="ai-section">
                    <h3 style="font-size: 24px; margin-bottom: 15px; color: #388e3c;">
                        💡 Organization-wide Improvements
                    </h3>
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #4caf50; line-height: 1.7;">
                        ${formatMarkdownContent(results.organizationImprovements)}
                    </div>
                </div>
                
                <div class="ai-section">
                    <h3 style="font-size: 24px; margin-bottom: 15px; color: #1976d2;">
                        🔍 Individual Flow Analysis
                    </h3>
                    <p style="margin-bottom: 20px; color: #666; font-style: italic;">
                        📋 Detailed analysis of each flow with business descriptions and improvement opportunities
                    </p>
                    
                    ${results.flowAnalysis.map((flow, index) => `
                        <div style="margin-bottom: 30px; padding: 25px; background: white; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
                            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #1976d2, #42a5f5); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: white; font-weight: bold; font-size: 18px;">
                                    ${index + 1}
                                </div>
                                <h4 style="color: #1976d2; margin: 0; font-size: 20px; font-weight: 600;">
                                    🔄 ${generateFlowLinkFromName(flow.name)}
                                </h4>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <span style="font-size: 20px; margin-right: 8px;">📝</span>
                                    <strong style="color: #333; font-size: 16px;">Business Description</strong>
                                </div>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3; line-height: 1.6; font-size: 15px;">
                                    ${formatMarkdownContent(flow.businessDescription)}
                                </div>
                            </div>
                            
                            <div>
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <span style="font-size: 20px; margin-right: 8px;">🚀</span>
                                    <strong style="color: #333; font-size: 16px;">Improvement Opportunities</strong>
                                </div>
                                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50; line-height: 1.6; font-size: 15px;">
                                    ${formatMarkdownContent(flow.improvements)}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            aiResults.style.display = 'block';
            aiResults.scrollIntoView({ behavior: 'smooth' });
        }

        function formatMarkdownContent(content) {
            if (!content) return '';
            
            // Convert markdown to HTML with proper formatting
            return content
                // Bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1976d2; font-weight: 600;">$1</strong>')
                // Handle numbered lists
                .replace(/^\d+\.\s+(.+)/gm, '<div style="margin: 8px 0;"><span style="color: #1976d2; font-weight: bold;">•</span> $1</div>')
                // Handle bullet points
                .replace(/^-\s+(.+)/gm, '<div style="margin: 8px 0; margin-left: 15px;"><span style="color: #666;">→</span> $1</div>')
                // Handle paragraphs (double line breaks)
                .replace(/\n\n/g, '</p><p style="margin: 15px 0;">')
                // Handle single line breaks
                .replace(/\n/g, '<br>')
                // Wrap in paragraph if not already wrapped
                .replace(/^(?!<)/, '<p style="margin: 15px 0;">')
                .replace(/(?!>)$/, '</p>')
                // Clean up empty paragraphs
                .replace(/<p[^>]*><\/p>/g, '')
                // Add spacing for benefits/implementation sections
                .replace(/(Benefit|Implementation|Why beneficial):/gi, '<br><strong style="color: #4caf50;">$&</strong>')
                // Highlight technical terms
                .replace(/\b(flow|element|connector|variable|formula|record|field)\b/gi, '<code style="background: #f5f5f5; padding: 2px 4px; border-radius: 3px; font-size: 13px;">$1</code>');
        }

        function showChatInterface() {
            document.getElementById('chatInterface').style.display = 'block';
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const question = input.value.trim();
            
            if (!question) return;
            
            const chatMessages = document.getElementById('chatMessages');
            const sendButton = document.getElementById('chatSend');
            
            // Add user message
            addChatMessage('user', question);
            input.value = '';
            
            // Disable send button during request
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';
            
            try {
                const response = await fetch('/api/flows/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    addChatMessage('ai', result.response);
                } else {
                    // Handle specific error types with user-friendly messages
                    let errorMessage = 'Sorry, I encountered an error processing your question.';
                    
                    if (response.status === 503 || result.statusCode === 529) {
                        errorMessage = '🕒 The AI service is temporarily overloaded. You can try asking your question again in a few minutes, or try switching to a different AI provider in the "Configure AI" settings.';
                    } else if (response.status === 400) {
                        errorMessage = '❓ I had trouble understanding your question. Could you please rephrase it?';
                    } else if (result.error) {
                        errorMessage = result.error;
                    }
                    
                    addChatMessage('ai', errorMessage);
                }
                
            } catch (error) {
                addChatMessage('ai', '🔌 Connection error. Please check your internet connection and try again.');
                console.error('Chat error:', error);
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
            }
        }

        function addChatMessage(type, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            if (type === 'user') {
                messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
            } else {
                // Just display the message as plain text
                messageDiv.innerHTML = `<strong>AI Assistant:</strong><br><br>${message}`;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatChatMessage(message) {
            if (!message) return message;
            
            // NO FORMATTING AT ALL - just return clean text
            return message.trim();
        }

        // Flow Interaction Functions
        function startFlowInteraction() {
            if (selectedFlows.length === 0) {
                alert('Please select at least one flow first.');
                return;
            }
            
            // Hide flow selection and show interaction interface
            document.getElementById('flowSelection').style.display = 'none';
            document.getElementById('flowInteractionInterface').style.display = 'block';
            
            // Clear previous messages except the initial AI message
            const interactionMessages = document.getElementById('interactionMessages');
            const firstMessage = interactionMessages.firstElementChild;
            interactionMessages.innerHTML = '';
            interactionMessages.appendChild(firstMessage);
        }
        
        function closeFlowInteraction() {
            document.getElementById('flowInteractionInterface').style.display = 'none';
            document.getElementById('flowSelection').style.display = 'block';
        }
        
        function handleInteractionKeyPress(event) {
            if (event.key === 'Enter') {
                sendInteractionMessage();
            }
        }
        
        async function sendInteractionMessage() {
            const input = document.getElementById('interactionInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addInteractionMessage('user', message);
            input.value = '';
            
            // Disable send button while processing
            const sendButton = document.getElementById('interactionSend');
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';
            
            try {
                // Validate AI configuration
                const aiProvider = localStorage.getItem('aiProvider');
                const apiKey = localStorage.getItem('aiApiKey');
                
                if (!aiProvider || !apiKey) {
                    addInteractionMessage('ai', 'Please configure your AI settings first. Click the "Configure AI" button in the header.');
                    sendButton.disabled = false;
                    sendButton.textContent = 'Send';
                    return;
                }
                
                // Get selected flows data
                const selectedFlowsData = allFlows.filter(flow => selectedFlows.includes(flow.Id));
                
                if (selectedFlowsData.length === 0) {
                    addInteractionMessage('ai', 'No flows are selected. Please select some flows first.');
                    sendButton.disabled = false;
                    sendButton.textContent = 'Send';
                    return;
                }
                
                // Get provider-specific size limits (in characters, conservative estimates)
                const providerLimits = {
                    'openai': 400000,    // ~400KB (safe margin from 500KB+ capacity)
                    'claude': 600000,    // ~600KB (safe margin from 800KB+ capacity)
                    'gemini': 2000000,   // ~2MB (safe margin from 4MB+ capacity)
                    'mistral': 100000    // ~100KB (safe margin from 128KB+ capacity)
                };
                
                const maxSize = providerLimits[aiProvider] || 100000; // Default to 100KB if provider unknown
                const originalDataString = JSON.stringify(selectedFlowsData);
                let flowsToSend = selectedFlowsData;
                let truncationApplied = false;
                
                console.log(`Flow data size: ${originalDataString.length} chars, limit: ${maxSize} chars for ${aiProvider}`);
                
                if (originalDataString.length > maxSize) {
                    console.log(`Flow data too large (${originalDataString.length} chars), applying progressive truncation...`);
                    
                    // Progressive truncation strategy - preserve most important flow data
                    flowsToSend = selectedFlowsData.map(flow => {
                        if (!flow.Metadata) return flow;
                        
                        // Level 1: Truncate long text fields only
                        const truncatedFlow = {
                            ...flow,
                            Description: flow.Description && flow.Description.length > 500 ? 
                                flow.Description.substring(0, 500) + '...' : flow.Description,
                            Metadata: {
                                ...flow.Metadata,
                                // Preserve all flow elements - these are crucial for understanding flow logic
                                decisions: flow.Metadata.decisions,
                                processMetadataValues: flow.Metadata.processMetadataValues,
                                recordCreates: flow.Metadata.recordCreates,
                                recordUpdates: flow.Metadata.recordUpdates,
                                recordLookups: flow.Metadata.recordLookups,
                                screens: flow.Metadata.screens,
                                assignments: flow.Metadata.assignments,
                                variables: flow.Metadata.variables,
                                constants: flow.Metadata.constants,
                                formulas: flow.Metadata.formulas,
                                subflows: flow.Metadata.subflows,
                                actionCalls: flow.Metadata.actionCalls,
                                loops: flow.Metadata.loops,
                                waits: flow.Metadata.waits,
                                // Keep essential process info
                                processType: flow.Metadata.processType,
                                startElementReference: flow.Metadata.startElementReference,
                                apiVersion: flow.Metadata.apiVersion,
                                status: flow.Metadata.status,
                                // Truncate less critical system metadata
                                description: flow.Metadata.description && flow.Metadata.description.length > 300 ? 
                                    flow.Metadata.description.substring(0, 300) + '...' : flow.Metadata.description
                            }
                        };
                        
                        return truncatedFlow;
                    });
                    
                    // Check if Level 1 truncation was sufficient
                    const level1Size = JSON.stringify(flowsToSend).length;
                    console.log(`After Level 1 truncation: ${level1Size} chars`);
                    
                    if (level1Size > maxSize) {
                        console.log('Level 1 truncation insufficient, applying Level 2...');
                        // Level 2: Remove system metadata but keep all flow elements
                        flowsToSend = flowsToSend.map(flow => ({
                            ...flow,
                            Metadata: flow.Metadata ? {
                                // Keep all flow elements - these are essential
                                decisions: flow.Metadata.decisions,
                                processMetadataValues: flow.Metadata.processMetadataValues,
                                recordCreates: flow.Metadata.recordCreates,
                                recordUpdates: flow.Metadata.recordUpdates,
                                recordLookups: flow.Metadata.recordLookups,
                                screens: flow.Metadata.screens,
                                assignments: flow.Metadata.assignments,
                                variables: flow.Metadata.variables,
                                constants: flow.Metadata.constants,
                                formulas: flow.Metadata.formulas,
                                subflows: flow.Metadata.subflows,
                                actionCalls: flow.Metadata.actionCalls,
                                loops: flow.Metadata.loops,
                                waits: flow.Metadata.waits,
                                processType: flow.Metadata.processType,
                                startElementReference: flow.Metadata.startElementReference
                            } : undefined
                        }));
                        
                        const level2Size = JSON.stringify(flowsToSend).length;
                        console.log(`After Level 2 truncation: ${level2Size} chars`);
                        
                        if (level2Size > maxSize) {
                            console.log('Level 2 truncation insufficient, applying Level 3...');
                            // Level 3: Limit array elements (last resort)
                            flowsToSend = flowsToSend.map(flow => ({
                                ...flow,
                                Metadata: flow.Metadata ? {
                                    processType: flow.Metadata.processType,
                                    startElementReference: flow.Metadata.startElementReference,
                                    variables: flow.Metadata.variables ? flow.Metadata.variables.slice(0, 10) : undefined,
                                    decisions: flow.Metadata.decisions ? flow.Metadata.decisions.slice(0, 5) : undefined,
                                    screens: flow.Metadata.screens ? flow.Metadata.screens.slice(0, 5) : undefined,
                                    assignments: flow.Metadata.assignments ? flow.Metadata.assignments.slice(0, 10) : undefined,
                                    recordCreates: flow.Metadata.recordCreates ? flow.Metadata.recordCreates.slice(0, 5) : undefined,
                                    recordUpdates: flow.Metadata.recordUpdates ? flow.Metadata.recordUpdates.slice(0, 5) : undefined
                                } : undefined
                            }));
                        }
                    }
                    
                    truncationApplied = true;
                    const finalSize = JSON.stringify(flowsToSend).length;
                    console.log(`Final flow data size: ${finalSize} chars`);
                    
                    if (truncationApplied) {
                        addInteractionMessage('ai', `Note: Flow data was optimized for ${aiProvider} (${originalDataString.length} → ${finalSize} chars). Most flow elements preserved.`);
                    }
                } else {
                    console.log(`Flow data fits within ${aiProvider} limits, no truncation needed.`);
                }
                
                // Send to backend
                const response = await fetch('/api/chat/flows', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        flowsData: flowsToSend,
                        aiProvider: aiProvider,
                        apiKey: apiKey
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                addInteractionMessage('ai', data.response);
                
            } catch (error) {
                console.error('Error sending flow interaction message:', error);
                
                // Provide specific error messages based on error type
                let errorMessage = 'Sorry, I encountered an error processing your request. Please try again.';
                
                if (error.message.includes('HTTP error! status: 401')) {
                    errorMessage = 'Authentication failed. Please log in again.';
                } else if (error.message.includes('HTTP error! status: 400')) {
                    errorMessage = 'Invalid request. Please check your AI configuration and try again.';
                } else if (error.message.includes('HTTP error! status: 503') || error.message.includes('HTTP error! status: 529')) {
                    errorMessage = 'AI service is temporarily overloaded. Please try again in a few minutes.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                }
                
                addInteractionMessage('ai', errorMessage);
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
            }
        }
        
        function addInteractionMessage(type, message) {
            const interactionMessages = document.getElementById('interactionMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            if (type === 'user') {
                messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
            } else {
                messageDiv.innerHTML = `<strong>AI Assistant:</strong><br><br>${message}`;
            }
            
            interactionMessages.appendChild(messageDiv);
            interactionMessages.scrollTop = interactionMessages.scrollHeight;
        }
    </script>
</body>
</html>